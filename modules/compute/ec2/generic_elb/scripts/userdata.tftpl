#!/bin/bash
## --------------------------------------------------------------------------------------------------------------------
## Use data start
## --------------------------------------------------------------------------------------------------------------------
echo "#### Iniciado user data ####"

## --------------------------------------------------------------------------------------------------------------------
## Update /etc/fstab and mount filesystems
## --------------------------------------------------------------------------------------------------------------------
echo "#### Montagem do sistema de arquivos EFS ####"
echo "${EFS_DNS_NAME}:/ /var/www/magento2 efs defaults,_netdev 0 0" >> /etc/fstab
mount -a

## --------------------------------------------------------------------------------------------------------------------
## Change /var/www owner to www-data
## --------------------------------------------------------------------------------------------------------------------
echo "#### Definine proprietario de /var/www ####"
chown -R www-data:www-data /var/www

## --------------------------------------------------------------------------------------------------------------------
## Download git repository
## --------------------------------------------------------------------------------------------------------------------
echo "#### Iniciando ssh-agent ####"
eval $(ssh-agent -s)

echo "#### Adicionando chave privada do github ao ssh-agent ####"
PRIVATE_KEY=$(aws ssm get-parameter --name '/github_secrets/ssh_private_key_github' --with-decryption --query 'Parameter.Value' --output text)
echo "$PRIVATE_KEY" > /tmp/github_ssh_key
chmod 600 /tmp/github_ssh_key
ssh-add /tmp/github_ssh_key
rm /tmp/github_ssh_key

echo "#### Apagando dados de /var/www/html ####"
cd /var/www/html
rm -rf ./*

echo "#### Configurando /var/www/html com um diret처rio seguro para o git. ####"
git config --global --add safe.directory /var/www/html

echo "#### Inicializando reposit처rio git ####"
git init

echo "#### Adicionando remote 'origin': ${APP_REPOSITORY_URL} ####"
git remote add origin ${APP_REPOSITORY_URL}

echo "#### Excutando git fetch. ####"
GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=no' git fetch origin

echo "#### Executando git reset --hard para origin/master ####"
git reset --hard origin/master

## --------------------------------------------------------------------------------------------------------------------
## Setup Easy Appointments
## --------------------------------------------------------------------------------------------------------------------
cd /var/www/html
cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default.bak
cp -f ./nginx.conf /etc/nginx/sites-available/default

echo "#### Alterando owner do diret처rio /var/www/html para www-data ####"
chown -R www-data:www-data /var/www/

echo "#### Acessando /var/www/html. ####"
cd /var/www/html

echo "#### Define permiss천es para 'storage' ####"
chmod a+rwx ./storage

echo "#### Configura arquivo 'config-sample.php' e 'config.php' ####"
sed -i "s|const BASE_URL = '.*';|const BASE_URL = '${DOMAIN}';|" config-sample.php
sed -i "s|const DB_HOST = '.*';|const DB_HOST = '${DB_HOST}';|" config-sample.php
sed -i "s|const DB_NAME = '.*';|const DB_NAME = '${DB_NAME}';|" config-sample.php
sed -i "s|const DB_USERNAME = '.*';|const DB_USERNAME = '${DB_USERNAME}';|" config-sample.php
sed -i "s|const DB_PASSWORD = '.*';|const DB_PASSWORD = '${DB_PASSWORD}';|" config-sample.php

sudo -u www-data cp config-sample.php config.php

echo "#### Executando composer install ####"
sudo -u www-data composer install

echo "#### Executando npm install ####"
sudo -u www-data npm install

# echo "#### Executando npm run build ####"
sudo -u www-data npm run build

## --------------------------------------------------------------------------------------------------------------------
## NGINX Configuration
## --------------------------------------------------------------------------------------------------------------------
# echo "#### Configurar nginx"
# bash -c 'cat <<EOF > /etc/nginx/conf.d/magento2.conf
# upstream fastcgi_backend {
#   server unix:/run/php/php8.3-fpm.sock;
# }

# server {
#   listen 80;
#   server_name ${DOMAIN} www.${DOMAIN};
#   set \$MAGE_ROOT /var/www/html;
#   include /var/www/magento2/nginx.conf.sample;
# }
# EOF'

echo ${MEU_TESTE} > meu_teste.conf

## --------------------------------------------------------------------------------------------------------------------
## PHP and NGINX reload and restart
## --------------------------------------------------------------------------------------------------------------------
systemctl daemon-reload
systemctl restart php8.3-fpm.service
systemctl restart nginx

## --------------------------------------------------------------------------------------------------------------------
## Create finish flag files on /tmp/userdata_finished
## This file is read by terraform remote exec and sinalize that user data is finished
## and terraform scripts com follow.
## --------------------------------------------------------------------------------------------------------------------
echo "#### Finalizado user data ####"
sudo -u ubuntu touch /tmp/userdata_finished